%%
%% This is file `multibabel.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% multibabel.dtx  (with options: `pkg')
%% ----------------------------------------------------------------
%% multibabel -- multiple language versions from common source
%% E-mail: matthias.werner@informatik.tu-chemnitz.de
%% Released under the LaTeX Project Public License v1.3c or later
%% See http://www.latex-project.org/lppl.txt
%% ----------------------------------------------------------------
%% 
%%  (C) 2022-2025 Matthias Werner
%%
%%  Package multibabel - babel interface to generate documents
%%                       in different languages from common source.
%%
\NeedsTeXFormat{LaTeX2e}[2022/06/01]
\def\packagename{multibabel}
\def\packageversion{2025/08/10 v0.9.0d}
\ProvidesPackage{\packagename}[\packageversion\space babel interface for language versions]
\ExplSyntaxOn
\sys_if_engine_luatex:TF{
  \RequirePackage{luacode}
}{
 \ClassError{\packagename}{\MessageBreak
  ************************************************\MessageBreak
  *~LuaLaTeX~is~required~to~use~this~package. \MessageBreak
  *~Sorry! \MessageBreak
  ************************************************
 }{Use~this~package~with~LuaLaTex.}
\ExplSyntaxOff

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand\IfValidBabelName[1]{%
  \begingroup
  \def\PackageError##1##2##3{\endgroup\@secondoftwo}%
  % Test to load:
  \babelprovide{#1}%
  \endgroup\@firstoftwo
}
\newcommand\IfValidBabelTag[1]{%
  \begingroup
  \edef\bbl@tempa{#1}%
    % We use an internal babel function, not an official API.
  \expandafter\bbl@bcplookup\bbl@tempa-\@empty-\@empty-\@empty\@@
  \ifx\bbl@bcp\relax
      \endgroup\@secondoftwo%
  \else
      \endgroup\@firstoftwo%
  \fi
}
\newcommand*\mbLoadLanguageForTag[2][]{%
  \begingroup
  \edef\bbl@tempa{#2}%
  % We use an internal babel function, not an official API
  \expandafter\bbl@bcplookup\bbl@tempa-\@empty-\@empty-\@empty\@@
  \ifx\bbl@bcp\relax
    \ifx#1\relax
      \global\cslet{#1}{\@empty}
    \fi
    \endgroup
  \else
    % Read the corresponding ini file.
    \bbl@read@ini{\bbl@bcp}\m@ne
    \ifx#1\relax
      \csxdef{#1}{\languagename}
    \fi
    \endgroup
  \fi
}
\newtoggle{mbLangsSet}\togglefalse{mbLangsSet}
\ExplSyntaxOn
\DeclareKeys[multibabel]{
  languages.code = {
    \clist_new:N\cl_lang
    \clist_gset:Nn{\cl_lang}{#1}
    \clist_map_inline:Nn{\cl_lang}{
      \IfValidBabelName{#1}{
        \babelprovide{#1}
      }{
        \IfValidBabelTag{#1}{
          \mbLoadLanguageForTag{#1}
        }{
          \PackageError{\packagename}{Couldn't~resolve~language~'#1'}{
            Use~valid~language~selector~in~option~'languages'.}
          \aftergroup\endinput
        }
      }
      \toggletrue{mbLangsSet}
    }
  },
  languages.usages=load,
  destlang.code = {
    \IfValidBabelName{#1}{% valid babel language
      \edef\mdDestinationLanguage{#1}
    }{% no babel language
      \IfValidBabelTag{#1}{% valid language tag
        \edef\mdDestinationLanguage{#1}
      }{% no valid tag
        \str_if_eq:eeTF{\str_range:Nnn{#1}{1}{3}}{job}{% destlang=job n
          \RequirePackage{varsfromjobname}
          \edef\mdDestinationLanguage{\getfromjobname{\str_range:Nnn{#1}{-1}{-1}}}
        }{% destlang != job
          \str_if_eq:nnTF{#1}{meta}{% destlang=meta
            \IfDocumentMetadataTF{% \DocumentMetadata is loaded.
              % No check for correct language is needed, since at this point in
              % time, babel is already loaded and has checked the language, if
              % \DocumentMetadata is loaded.
              \edef\mdDestinationLanguage{ \g_document_properties_prop { document/lang }}
            }{%
              \PackageError{\packagename}{Option~destlang=meta,~but~no~
                \string\DocumentMetadata~is~provided}{Provide~\string\DocumentMetadata.}
            }
          }{% destlang != meta
            \PackageWarnigNoLine{\packagename}{I~wasn't~able~to~recognize~the~
              destination~language.\MessageBreak
              I'll~go~with~'english'
            }
          }
        }
      }
    }
  },
  destlang.usage=load,
  static prefix.store=\mb@sprefix,
  static prefix.usage=load,
}%

\ProcessOptions\relax
\iftoggle{mbLangsSet}{}{
  \PackageError{\packagename}{Option 'languages' not set.}{You have to provide a
  non-empty list of languages.}
}

\fi
%% This work is "maintained" (as per LPPL maintenance status) by
%% Matthias Werner.
%% 
%% This work consists of the file  multibabel.dtx
%% and the derived files           multibabel.pdf and
%%                                 multibabel.sty.
%%
%% End of file `multibabel.sty'.
